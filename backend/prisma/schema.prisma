// Prisma schema for POS System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model with roles
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      Role     @default(CASHIER)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sales        Sale[]
  purchases    Purchase[]
  returns      Return[]
  journalEntries JournalEntry[]
  openedCashRegisters CashRegister[] @relation("CashRegisterOpenedBy")
  closedCashRegisters CashRegister[] @relation("CashRegisterClosedBy")
  cashMovements CashMovement[]
  refreshTokens RefreshToken[]

  @@map("postblUsers")
}

enum Role {
  ADMIN
  MANAGER
  CASHIER
}

// Product model
model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  sku         String   @unique
  barcode     String?  @unique
  price       Float
  costPrice   Float
  stock       Int      @default(0)
  minStock    Int      @default(0)
  categoryId  String
  supplierId  String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  category    Category     @relation(fields: [categoryId], references: [id])
  supplier    Supplier?    @relation(fields: [supplierId], references: [id])
  saleItems   SaleItem[]
  purchaseItems PurchaseItem[]
  returnItems ReturnItem[]

  @@map("postblProducts")
}

// Category model
model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  products    Product[]

  @@map("postblCategories")
}

// Supplier model
model Supplier {
  id        String   @id @default(cuid())
  name      String
  email     String?  @unique
  phone     String?
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products    Product[]
  purchases   Purchase[]

  @@map("postblSuppliers")
}

// Customer model
model Customer {
  id        String   @id @default(cuid())
  name      String
  email     String?  @unique
  phone     String?
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sales     Sale[]

  @@map("postblCustomers")
}

// Purchase model
model Purchase {
  id         String   @id @default(cuid())
  supplierId String
  userId     String
  total      Float
  status     PurchaseStatus @default(PENDING)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  supplier    Supplier       @relation(fields: [supplierId], references: [id])
  user        User           @relation(fields: [userId], references: [id])
  items       PurchaseItem[]

  @@map("postblPurchases")
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  CANCELLED
}

// PurchaseItem model
model PurchaseItem {
  id         String  @id @default(cuid())
  purchaseId String
  productId  String
  quantity   Int
  unitPrice  Float
  total      Float

  // Relations
  purchase   Purchase @relation(fields: [purchaseId], references: [id])
  product    Product  @relation(fields: [productId], references: [id])

  @@map("postblPurchaseItems")
}

// Sale model
model Sale {
  id         String   @id @default(cuid())
  customerId String?
  userId     String
  total      Float
  tax        Float    @default(0)
  discount   Float    @default(0)
  status     SaleStatus @default(COMPLETED)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  customer   Customer?    @relation(fields: [customerId], references: [id])
  user       User         @relation(fields: [userId], references: [id])
  items      SaleItem[]
  returns    Return[]

  @@map("postblSales")
}

enum SaleStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

// SaleItem model
model SaleItem {
  id        String  @id @default(cuid())
  saleId    String
  productId String
  quantity  Int
  unitPrice Float
  total     Float

  // Relations
  sale     Sale    @relation(fields: [saleId], references: [id])
  product  Product @relation(fields: [productId], references: [id])

  @@map("postblSaleItems")
}

// Return model
model Return {
  id         String   @id @default(cuid())
  saleId     String
  userId     String
  reason     String?
  total      Float
  status     ReturnStatus @default(PENDING)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  sale     Sale        @relation(fields: [saleId], references: [id])
  user     User        @relation(fields: [userId], references: [id])
  items    ReturnItem[]

  @@map("postblReturns")
}

enum ReturnStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

// ReturnItem model
model ReturnItem {
  id        String  @id @default(cuid())
  returnId  String
  productId String
  quantity  Int
  unitPrice Float
  total     Float

  // Relations
  return_  Return  @relation(fields: [returnId], references: [id])
  product  Product @relation(fields: [productId], references: [id])

  @@map("postblReturnItems")
}

// CashRegister model
model CashRegister {
  id          String   @id @default(cuid())
  name        String
  isOpen      Boolean  @default(false)
  openingBalance Float   @default(0)
  currentBalance Float   @default(0)
  openedAt    DateTime?
  closedAt    DateTime?
  openedById  String?
  closedById  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  openedBy    User? @relation("CashRegisterOpenedBy", fields: [openedById], references: [id])
  closedBy    User? @relation("CashRegisterClosedBy", fields: [closedById], references: [id])
  movements   CashMovement[]

  @@map("postblCashRegisters")
}

// CashMovement model for tracking cash deposits, withdrawals, and transactions
model CashMovement {
  id            String   @id @default(cuid())
  cashRegisterId String
  type          CashMovementType
  amount        Float
  description   String?
  reference     String?  // Sale ID, Purchase ID, etc.
  userId        String
  createdAt     DateTime @default(now())

  // Relations
  cashRegister  CashRegister @relation(fields: [cashRegisterId], references: [id])
  user          User         @relation(fields: [userId], references: [id])

  @@map("postblCashMovements")
}

enum CashMovementType {
  OPENING
  SALE
  RETURN
  DEPOSIT
  WITHDRAWAL
  CLOSING
}

// Account model (Chart of Accounts)
model Account {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  type        AccountType
  parentId    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  parent      Account?     @relation("AccountHierarchy", fields: [parentId], references: [id])
  children    Account[]    @relation("AccountHierarchy")
  debitJournalEntries JournalEntry[] @relation("JournalEntryDebitAccount")
  creditJournalEntries JournalEntry[] @relation("JournalEntryCreditAccount")

  @@map("postblAccounts")
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

// JournalEntry model
model JournalEntry {
  id          String   @id @default(cuid())
  date        DateTime
  description String
  debitAccountId  String
  creditAccountId String
  amount      Float
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  debitAccount  Account @relation("JournalEntryDebitAccount", fields: [debitAccountId], references: [id])
  creditAccount Account @relation("JournalEntryCreditAccount", fields: [creditAccountId], references: [id])
  user          User    @relation(fields: [userId], references: [id])

  @@map("postblJournalEntries")
}

// RefreshToken model for JWT refresh functionality
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id])

  @@map("postblRefreshTokens")
}